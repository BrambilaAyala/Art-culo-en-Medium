<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <title>Clasificador de Aves ONNX</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <style>
      #resultado {
        font-weight: bold;
        font-size: 1.5rem;
        text-align: center;
        min-height: 60px;
        margin-top: 10px;
      }
      .confidence {
        font-size: 1rem;
        color: #666;
      }
      .top-predictions {
        margin-top: 10px;
        text-align: left;
      }
      .prediction-item {
        padding: 5px;
        border-bottom: 1px solid #eee;
      }
    </style>
  </head>
  <body>
    
    <main>
      <div class="px-4 py-2 my-2 text-center border-bottom">
        <img class="d-block mx-auto mb-2" src="LogotipoV2-Simple.png" alt="" width="80" height="80">
        <h1 class="display-5 fw-bold">Reconocimiento de Aves (ONNX)</h1>
        <div class="col-lg-6 mx-auto">
          <p class="lead mb-0">Clasificación de imágenes de <strong>Aves</strong> usando la cámara web utilizando ONNX Runtime Web</p>
          <p class="lead mb-4">Revisa <a href="https://youtube.com/RingaTech">mi canal</a> para este y otros proyectos</p>
        </div>
      </div>

      <div class="b-example-divider"></div>

      <div class="container mt-5">
        <div class="row">
          <div class="col-12 col-md-6 offset-md-3 text-center">
            <div class="mb-3">
              <video id="video" playsinline autoplay style="width: 1px; height: 1px; position: absolute;"></video>
              <button class="btn btn-primary mb-3" id="cambiar-camara" onclick="cambiarCamara();">Cambiar cámara</button>
            </div>
            <canvas id="canvas" width="400" height="400" style="max-width: 100%; border: 2px solid #ddd;"></canvas>
            <canvas id="otrocanvas" width="224" height="224" style="display: none"></canvas>
            <div id="resultado">Cargando Modelo...</div>
            <div id="top-predictions" class="top-predictions"></div>         
          </div>
        </div>
      </div>

      <div class="b-example-divider"></div>

      <div class="bg-dark text-secondary mt-5 px-4 py-2 text-center">
        <div class="py-5">
          <h1 class="display-5 fw-bold text-white">Ringa Tech</h1>
          <div class="col-lg-6 mx-auto">
            <p class="fs-5 mb-4">Revisa <a href="https://youtube.com/RingaTech" class="text-white">mi canal</a> para videos de inteligencia artificial, programación, etc.</p>
          </div>
        </div>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    
    <script type="text/javascript">
      // Lista de clases de aves
      const clasesAves = [
        "ABBOTTS BOOBY", "AMERICAN GOLDFINCH", "AMETHYST WOODSTAR", "ANDEAN GOOSE", 
        "ANIANIAU", "ANTBIRD", "ANTILLEAN EUPHONIA", "ASIAN DOLLARD BIRD",
        "ASIAN GREEN BEE EATER", "AUSTRALASIAN FIGBIRD", "AZARAS SPINETAIL", 
        "AZURE TIT", "BANANAQUIT", "BAND TAILED GUAN", "BANDED BROADBILL", 
        "BANDED PITA", "BANDED STILT", "BAR-TAILED GODWIT", "BEARDED BARBET", 
        "BIRD OF PARADISE", "BLACK AND YELLOW BROADBILL", "BLACK FRANCOLIN", 
        "BLACK HEADED CAIQUE", "BLACK THROATED HUET", "BLACK THROATED WARBLER", 
        "BLACK VULTURE", "BLACK-NECKED GREBE", "BLOOD PHEASANT", 
        "BLUE GRAY GNATCATCHER", "BLUE THROATED TOUCANET", "BROWN CREPPER", 
        "BROWN NOODY", "BULWERS PHEASANT", "BURCHELLS COURSER", 
        "CAATINGA CACHOLOTE", "CACTUS WREN", "CALIFORNIA GULL", "CANARY", 
        "CAPE MAY WARBLER", "CAPE ROCK THRUSH", "CASPIAN TERN", 
        "CHESTNET BELLIED EUPHONIA", "CHINESE BAMBOO PARTRIDGE", 
        "CHINESE POND HERON", "CHIPPING SPARROW", "CHUKAR PARTRIDGE", 
        "CINNAMON FLYCATCHER", "COMMON STARLING", "CRANE HAWK", 
        "CREAM COLORED WOODPECKER", "CRESTED KINGFISHER", "CRESTED NUTHATCH", 
        "CRESTED SHRIKETIT", "CUBAN TODY", "CUBAN TROGON", 
        "CURL CRESTED ARACURI", "D-ARNAUDS BARBET", "DAURIAN REDSTART", 
        "DOUBLE BRESTED CORMARANT", "DOUBLE EYED FIG PARROT", "DUSKY LORY", 
        "EARED PITA", "EASTERN TOWEE", "EASTERN YELLOW ROBIN", 
        "ECUADORIAN HILLSTAR", "ELLIOTS PHEASANT", "EURASIAN BULLFINCH", 
        "FAIRY BLUEBIRD", "FASCIATED WREN", "FRILL BACK PIGEON", 
        "GAMBELS QUAIL", "GILA WOODPECKER", "GILDED FLICKER", "GO AWAY BIRD", 
        "GOLD WING WARBLER", "GOLDEN BOWER BIRD", "GOLDEN CHEEKED WARBLER", 
        "GOLDEN EAGLE", "GOLDEN PIPIT", "GRAY CATBIRD", "GRAY KINGBIRD", 
        "GREATER PEWEE", "GREATOR SAGE GROUSE", "GREEN BROADBILL", 
        "GREEN MAGPIE", "GREY PLOVER", "GURNEYS PITTA", "GYRFALCON", 
        "HAWAIIAN GOOSE", "HOUSE SPARROW", "INDIAN PITTA", "INDIAN ROLLER", 
        "INLAND DOTTEREL", "IWI", "JACOBIN PIGEON", "JOCOTOCO ANTPITTA", 
        "KAGU", "KING EIDER", "LAUGHING GULL", "LAZULI BUNTING", 
        "LOONEY BIRDS", "MAGPIE GOOSE", "MALABAR HORNBILL", "MANDRIN DUCK", 
        "MERLIN", "MILITARY MACAW", "ORNATE HAWK EAGLE", "OSPREY", "OSTRICH", 
        "PAINTED BUNTING", "PALILA", "PALM NUT VULTURE", "PARADISE TANAGER", 
        "PARAKETT AUKLET", "PARUS MAJOR", "PATAGONIAN SIERRA FINCH", 
        "PEACOCK", "PHILIPPINE EAGLE", "PINK ROBIN", "PLUSH CRESTED JAY", 
        "PURPLE MARTIN", "RED FACED WARBLER", "RED SHOULDERED HAWK", 
        "RED TAILED THRUSH", "RED WINGED BLACKBIRD", "REGENT BOWERBIRD", 
        "ROCK DOVE", "ROUGH LEG BUZZARD", "RUBY CROWNED KINGLET", 
        "RUFOUS TREPE", "SCARLET FACED LIOCICHLA", "SCARLET MACAW", 
        "SNOW GOOSE", "SORA", "SPOTTED CATBIRD", "SPOTTED WHISTLING DUCK", 
        "SQUACCO HERON", "STEAMER DUCK", "SUNBITTERN", "TAZMANIAN HEN", 
        "TEAL DUCK", "TOUCHAN", "TOWNSENDS WARBLER", "TURKEY VULTURE", 
        "TURQUOISE MOTMOT", "UMBRELLA BIRD", "WATTLED CURASSOW", 
        "WHIMBREL", "WHITE BREASTED WATERHEN", "WHITE BROWED CRAKE", 
        "WHITE CRESTED HORNBILL", "WHITE THROATED BEE EATER", "ZEBRA DOVE"
      ];

      var tamano = 400;
      var tamano_modelo = 224;
      var video = document.getElementById("video");
      var canvas = document.getElementById("canvas");
      var otrocanvas = document.getElementById("otrocanvas");
      var ctx = canvas.getContext("2d", { willReadFrequently: true });
      var currentStream = null;
      var facingMode = "user";
      var session = null;

      // Función para cargar el modelo ONNX
      async function cargarModeloOnnx() {
        console.log("Cargando modelo ONNX...");
        try {
          session = await ort.InferenceSession.create('aves_resnet.onnx');
          console.log("Modelo ONNX cargado");
          console.log("Input names:", session.inputNames);
          console.log("Output names:", session.outputNames);
          
          // Obtener información sobre la entrada del modelo
          const input = session.inputNames[0];
          const inputInfo = session.inputValues.get(input);
          console.log("Input shape:", inputInfo.dims);
          
          document.getElementById("resultado").innerHTML = "Modelo Cargado - Apunte a un ave";
        } catch (e) {
          console.error("Error al cargar el modelo ONNX:", e);
          document.getElementById("resultado").innerHTML = "Error al cargar ONNX: " + e.message;
        }
      }

      // Inicializar
      (async() => {
        await cargarModeloOnnx();
        mostrarCamara();
      })();

      function mostrarCamara() {
        var opciones = {
          audio: false,
          video: {
            width: tamano, 
            height: tamano,
            facingMode: facingMode
          }
        }

        if (navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices.getUserMedia(opciones)
            .then(function(stream) {
              currentStream = stream;
              video.srcObject = currentStream;
              video.onloadedmetadata = function() {
                procesarCamara();
                predecir();
              };
            })
            .catch(function(err) {
              console.error("Error al acceder a la cámara:", err);
              document.getElementById("resultado").innerHTML = "Error de cámara: " + err.message;
            });
        }
      }

      function cambiarCamara() {
        if (currentStream) {
          currentStream.getTracks().forEach(track => {
            track.stop();
          });
        }

        facingMode = facingMode == "user" ? "environment" : "user";
        mostrarCamara();
      }

      function procesarCamara() {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          ctx.drawImage(video, 0, 0, tamano, tamano);
        }
        setTimeout(procesarCamara, 50);
      }

      async function predecir() {
        if (session !== null) {
          try {
            // Redimensionar imagen
            resample_single(canvas, tamano_modelo, tamano_modelo, otrocanvas);
            var ctx2 = otrocanvas.getContext("2d", { willReadFrequently: true });
            var imgData = ctx2.getImageData(0, 0, tamano_modelo, tamano_modelo);
            
            // Preprocesamiento para formato NHWC [1, 224, 224, 3]
            const data = new Float32Array(tamano_modelo * tamano_modelo * 3);
            
            // Convertir a formato NHWC (Height-Width-Channel)
            let dataIndex = 0;
            for (let i = 0; i < imgData.data.length; i += 4) {
              data[dataIndex++] = imgData.data[i] / 255.0;     // R
              data[dataIndex++] = imgData.data[i + 1] / 255.0; // G
              data[dataIndex++] = imgData.data[i + 2] / 255.0; // B
              // Ignorar canal alpha (i + 3)
            }

            // Crear tensor [1, 224, 224, 3] - NHWC format
            const inputTensor = new ort.Tensor('float32', data, [1, tamano_modelo, tamano_modelo, 3]);

            // Ejecutar inferencia
            const feeds = { [session.inputNames[0]]: inputTensor };
            const results = await session.run(feeds);
            const output = results[session.outputNames[0]].data;

            // Obtener las 5 mejores predicciones
            const predictions = [];
            for (let i = 0; i < output.length; i++) {
              predictions.push({
                index: i,
                class: clasesAves[i] || `Ave ${i}`,
                confidence: output[i]
              });
            }

            // Ordenar por confianza descendente
            predictions.sort((a, b) => b.confidence - a.confidence);

            // Mostrar resultado principal
            const topPrediction = predictions[0];
            document.getElementById("resultado").innerHTML = 
              `${topPrediction.class}<br><span class="confidence">Confianza: ${(topPrediction.confidence * 100).toFixed(2)}%</span>`;

            // Mostrar top 5 predicciones
            let top5Html = '<h6>Top 5 predicciones:</h6>';
            for (let i = 0; i < Math.min(5, predictions.length); i++) {
              const pred = predictions[i];
              top5Html += `
                <div class="prediction-item">
                  ${pred.class}: ${(pred.confidence * 100).toFixed(2)}%
                </div>
              `;
            }
            document.getElementById("top-predictions").innerHTML = top5Html;

          } catch (error) {
            console.error("Error en predicción:", error);
          }
        }
        setTimeout(predecir, 1000); // Predecir cada segundo
      }

      // Función de redimensionamiento
      function resample_single(canvas, width, height, resize_canvas) {
        var width_source = canvas.width;
        var height_source = canvas.height;
        width = Math.round(width);
        height = Math.round(height);

        var ratio_w = width_source / width;
        var ratio_h = height_source / height;
        var ratio_w_half = Math.ceil(ratio_w / 2);
        var ratio_h_half = Math.ceil(ratio_h / 2);

        var ctx = canvas.getContext("2d");
        var ctx2 = resize_canvas.getContext("2d");
        var img = ctx.getImageData(0, 0, width_source, height_source);
        var img2 = ctx2.createImageData(width, height);
        var data = img.data;
        var data2 = img2.data;

        for (var j = 0; j < height; j++) {
          for (var i = 0; i < width; i++) {
            var x2 = (i + j * width) * 4;
            var weight = 0;
            var weights = 0;
            var weights_alpha = 0;
            var gx_r = 0;
            var gx_g = 0;
            var gx_b = 0;
            var gx_a = 0;
            var center_y = (j + 0.5) * ratio_h;
            var yy_start = Math.floor(j * ratio_h);
            var yy_stop = Math.ceil((j + 1) * ratio_h);
            for (var yy = yy_start; yy < yy_stop; yy++) {
              var dy = Math.abs(center_y - (yy + 0.5)) / ratio_h_half;
              var center_x = (i + 0.5) * ratio_w;
              var w0 = dy * dy;
              var xx_start = Math.floor(i * ratio_w);
              var xx_stop = Math.ceil((i + 1) * ratio_w);
              for (var xx = xx_start; xx < xx_stop; xx++) {
                var dx = Math.abs(center_x - (xx + 0.5)) / ratio_w_half;
                var w = Math.sqrt(w0 + dx * dx);
                if (w >= 1) continue;
                weight = 2 * w * w * w - 3 * w * w + 1;
                var pos_x = 4 * (xx + yy * width_source);
                gx_a += weight * data[pos_x + 3];
                weights_alpha += weight;
                if (data[pos_x + 3] < 255) weight = weight * data[pos_x + 3] / 250;
                gx_r += weight * data[pos_x];
                gx_g += weight * data[pos_x + 1];
                gx_b += weight * data[pos_x + 2];
                weights += weight;
              }
            }
            data2[x2] = gx_r / weights;
            data2[x2 + 1] = gx_g / weights;
            data2[x2 + 2] = gx_b / weights;
            data2[x2 + 3] = gx_a / weights_alpha;
          }
        }
        ctx2.putImageData(img2, 0, 0);
      }
    </script>
  </body>
</html>